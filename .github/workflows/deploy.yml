name: Deploy Docker Container to Azure VM

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch: {}

permissions:
  id-token: write      
  contents: read 

env:
  IMAGE_NAME: usersdbcode1

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v1
        with: 
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}

      - name: Get DB secrets from Key Vault
        id: secrets
        run: |
          DB_USERNAME=$(az keyvault secret show --vault-name Database-key-vault1 --name DB-username --query value -o tsv)
          DB_PASSWORD=$(az keyvault secret show --vault-name Database-key-vault1 --name DB-password --query value -o tsv)
          echo "DB_USERNAME=$DB_USERNAME" >> $GITHUB_ENV
          echo "DB_PASSWORD=$DB_PASSWORD" >> $GITHUB_ENV      

      - name: Login to Azure Container Registry
        uses: azure/docker-login@v1
        with:
          login-server: ${{ secrets.ACR_LOGIN_SERVER }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: Prepare SSH (key + known_hosts)
        run: |
          mkdir -p ~/.ssh && chmod 700 ~/.ssh
          cat > ~/.ssh/id_ed25519 <<'EOF'
          ${{ secrets.AZURE_VM_SSH_KEY }}
          EOF
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -p "${{ secrets.AZURE_VM_PORT || 22 }}" "${{ secrets.AZURE_VM_HOST }}" >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: SSH connectivity check
        run: |
          ssh -i ~/.ssh/id_ed25519 -o BatchMode=yes -o StrictHostKeyChecking=yes \
            -p ${{ secrets.AZURE_VM_PORT || 22 }} \
            ${{ secrets.AZURE_VM_USERNAME }}@${{ secrets.AZURE_VM_HOST }} "echo SSH_OK && hostname && date"


      - name: Remote deploy (pull & run Docker container)
        run: |
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=yes -p ${{ secrets.AZURE_VM_PORT || 22 }} \
            ${{ secrets.AZURE_VM_USERNAME }}@${{ secrets.AZURE_VM_HOST }} 'bash -s' <<'ENDSSH'
            set -eux  # Вмикаємо суворий режим та вивід команд

            # Передаємо всі необхідні змінні
            export SPRING_DATASOURCE_USERNAME="${{ env.DB_USERNAME }}"
            export SPRING_DATASOURCE_PASSWORD="${{ env.DB_PASSWORD }}"
            export ACR_LOGIN_SERVER="${{ secrets.ACR_LOGIN_SERVER }}"
            export IMAGE_NAME="${{ env.IMAGE_NAME }}"
            export IMAGE_TAG="${{ github.sha }}"
            export CONTAINER_NAME="${{ env.IMAGE_NAME }}-container"

            # Логін Docker на VM. 
            # Використовуємо Service Principal (який використовувався для Azure login) для логіну в ACR
            export ACR_USERNAME_SP="${{ secrets.AZURE_CLIENT_ID }}"
            export ACR_PASSWORD_SP="${{ secrets.AZURE_CLIENT_SECRET }}"
            
            echo "$ACR_PASSWORD_SP" | docker login "$ACR_LOGIN_SERVER" -u "$ACR_USERNAME_SP" --password-stdin

            # Зупиняємо і видаляємо старий контейнер, якщо він існує
            docker stop $CONTAINER_NAME || true
            docker rm $CONTAINER_NAME || true

            # Завантажуємо новий образ
            docker pull $ACR_LOGIN_SERVER/$IMAGE_NAME:$IMAGE_TAG

            # Запускаємо новий контейнер
            docker run -d \
              --name $CONTAINER_NAME \
              --restart always \
              -p 8080:8080 \
              -e SPRING_DATASOURCE_USERNAME="$SPRING_DATASOURCE_USERNAME" \
              -e SPRING_DATASOURCE_PASSWORD="$SPRING_DATASOURCE_PASSWORD" \
              $ACR_LOGIN_SERVER/$IMAGE_NAME:$IMAGE_TAG

            # (Опціонально) Очищуємо старі, невикористовувані образи
            docker image prune -a -f || true

            echo "Docker deploy завершено!"
          ENDSSH