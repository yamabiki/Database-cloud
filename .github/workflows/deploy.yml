name: Deploy to Azure VM

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch: {}
  permissions:
  id-token: write
  contents: read 

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare SSH (key + known_hosts)
        run: |
          mkdir -p ~/.ssh && chmod 700 ~/.ssh
          cat > ~/.ssh/id_ed25519 <<'EOF'
          ${{ secrets.AZURE_VM_SSH_KEY }}
          EOF
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -p "${{ secrets.AZURE_VM_PORT || 22 }}" "${{ secrets.AZURE_VM_HOST }}" >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Login to Azure
        uses: azure/login@v1
        with: 
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get DB secrets from Key Vault
        id: secrets
        run: |
          DB_USERNAME=$(az keyvault secret show --vault-name Database-key-vault1 --name DB-username --query value -o tsv)
          DB_PASSWORD=$(az keyvault secret show --vault-name Database-key-vault1 --name DB-password --query value -o tsv)
          echo "DB_USERNAME=$DB_USERNAME" >> $GITHUB_ENV
          echo "DB_PASSWORD=$DB_PASSWORD" >> $GITHUB_ENV      

      - name: SSH connectivity check
        run: |
          ssh -i ~/.ssh/id_ed25519 -o BatchMode=yes -o StrictHostKeyChecking=yes \
            -p ${{ secrets.AZURE_VM_PORT || 22 }} \
            ${{ secrets.AZURE_VM_USERNAME }}@${{ secrets.AZURE_VM_HOST }} "echo SSH_OK && hostname && date"

      - name: Rsync code to VM
        run: |
          rsync -az --delete \
            -e "ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=yes -p ${{ secrets.AZURE_VM_PORT || 22 }}" \
            --exclude '.git' --exclude '.github' --exclude 'target' \
            ./ ${{ secrets.AZURE_VM_USERNAME }}@${{ secrets.AZURE_VM_HOST }}:/home/${{ secrets.AZURE_VM_USERNAME }}/usersdbcode/

      - name: Remote deploy (stop + build + start)
        run: |
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=yes -p ${{ secrets.AZURE_VM_PORT || 22 }} \
            ${{ secrets.AZURE_VM_USERNAME }}@${{ secrets.AZURE_VM_HOST }} 'bash -s' <<'ENDSSH'
            set -eux

            export SPRING_DATASOURCE_USERNAME="${{ env.DB_USERNAME }}"
            export SPRING_DATASOURCE_PASSWORD="${{ env.DB_PASSWORD }}"

            APP_DIR="/home/${{ secrets.AZURE_VM_USERNAME }}/usersdbcode"
            cd "$APP_DIR"

            # Зупинка поточного додатку
            pkill -f "java.*demo" || echo "Додаток не був запущений"

            # Git оновлення
            git fetch origin
            branch=$(git rev-parse --abbrev-ref HEAD)
            git reset --hard origin/$branch

            # Збірка Maven
            if [ -d "demo" ]; then
              cd demo
              chmod +x mvnw
              ./mvnw clean package -DskipTests
            else
              echo "Каталог demo не знайдено"
              exit 1
            fi

            # Запуск нового додатку
            JAR_FILE=$(ls target/demo-*.jar | head -n1)
            if [ -z "$JAR_FILE" ]; then
              echo "JAR файл не знайдено"
              exit 1
            fi
            nohup java -jar "$JAR_FILE" > /home/${{ secrets.AZURE_VM_USERNAME }}/spring-boot.log 2>&1 &
            disown

            echo "Деплой завершено!"
